name: SonarQube Analysis - PR to main only

on:
  pull_request:
    branches: [main, master]  # ‚≠ê S√ì EM PRs PARA MAIN/MASTER ‚≠ê

permissions:
  contents: read       # Permiss√£o padr√£o para fazer checkout do c√≥digo
  pull-requests: write # ‚≠ê PERMISS√ÉO CR√çTICA: para criar coment√°rios no PR
  issues: write        # Pode ser necess√°ria em alguns casos

env:
  MIN_COVERAGE: 80  # ‚≠ê 80% conforme requisito do professor ‚≠ê
  IGNORE_PATTERNS: "**/*.dto.ts,**/*.enum.ts,**/value-objects/**,**/*.interface.ts,**/main.ts,**/index.ts,**/*.config.ts,**/migrations/**,**/seeders/**,**/*.module.ts"

jobs:
  build-and-test:
    name: üèóÔ∏è Build & Test (Required for PR)
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üèóÔ∏è Build application
        run: npm run build  # ou seu comando de build
        # Se n√£o tem build, pode remover ou usar: npm run compile
        
      - name: üß™ Run tests
        run: npm test
        
      - name: üìä Generate coverage report
        run: npm test -- --coverage --coverageReporters=lcov
  
  verify-coverage:
    name: üî¨ Verify 80% Test Coverage
    needs: build-and-test
    runs-on: ubuntu-latest
    
    # Sa√≠das para bloquear PR se falhar
    outputs:
      coverage_passed: ${{ steps.check-coverage.outputs.passed }}
      coverage_percentage: ${{ steps.check-coverage.outputs.coverage }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üìä Generate detailed coverage
        run: |
          npm test -- --coverage \
            --coverageReporters=json-summary \
            --coverageReporters=lcov \
            --coverageReporters=text
          
      - name: üîç Check 80% minimum coverage
        id: check-coverage
        run: |
          # Script simples para verificar 80%
          node -e "
          const fs = require('fs');
          
          // Carregar relat√≥rio
          const report = require('./coverage/coverage-summary.json');
          const totalCoverage = report.total?.lines?.pct || 0;
          
          console.log(\`üìä Overall test coverage: \${totalCoverage.toFixed(2)}%\`);
          console.log(\`üéØ Minimum required: 80%\`);
          
          if (totalCoverage >= 80) {
            console.log('‚úÖ Coverage meets requirements!');
            console.log(\`::set-output name=passed::true\`);
            console.log(\`::set-output name=coverage::\${totalCoverage.toFixed(2)}\`);
          } else {
            console.log('‚ùå Coverage below 80% minimum!');
            console.log('üö´ This PR cannot be merged');
            console.log(\`::set-output name=passed::false\`);
            console.log(\`::set-output name=coverage::\${totalCoverage.toFixed(2)}\`);
            process.exit(1);
          }
          "
          
      - name: üíæ Save coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-pr-${{ github.event.pull_request.number }}
          path: coverage/
  
  sonarqube-analysis:
    name: üì° SonarQube Analysis
    needs: verify-coverage
    runs-on: ubuntu-latest
    
    # S√≥ executa se coverage for >= 80%
    if: needs.verify-coverage.outputs.coverage_passed == 'true'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì¶ Install dependencies
        run: npm ci
        
      - name: üìÅ Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-pr-${{ github.event.pull_request.number }}
          
      - name: üîç Run SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.organization=${{ vars.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
            -Dsonar.qualitygate.wait=true
            -Dsonar.coverage.exclusions=${{ env.IGNORE_PATTERNS }}
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
  
  pr-validation:
    name: ‚úÖ PR Validation Summary
    needs: [build-and-test, verify-coverage, sonarqube-analysis]
    runs-on: ubuntu-latest
    
    # S√≥ executa se todos os jobs anteriores passaram
    if: always()
    
    steps:
      - name: üìã Create PR validation summary
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        env:
          COVERAGE: ${{ needs.verify-coverage.outputs.coverage_percentage }}
          COVERAGE_PASSED: ${{ needs.verify-coverage.outputs.coverage_passed }}
        with:
          script: |
            const { COVERAGE, COVERAGE_PASSED } = process.env;
            
            let comment = `## üìã PR Validation Summary\n\n`;
            
            if (COVERAGE_PASSED === 'true') {
              comment += `### ‚úÖ All Validations Passed!\n`;
              comment += `- **Build:** ‚úÖ Successful\n`;
              comment += `- **Tests:** ‚úÖ All passed\n`;
              comment += `- **Coverage:** ‚úÖ ${COVERAGE}% (minimum: 80%)\n`;
              comment += `- **SonarQube:** ‚úÖ Analysis completed\n\n`;
              comment += `This PR meets all requirements for merging.\n`;
            } else {
              comment += `### ‚ùå Validations Failed\n`;
              comment += `- **Coverage:** ‚ùå ${COVERAGE}% (minimum: 80%)\n`;
              comment += `- **SonarQube:** ‚è≠Ô∏è Skipped due to low coverage\n\n`;
              comment += `**This PR cannot be merged until coverage reaches 80%.**\n`;
            }
            
            comment += `\n---\n*Automated validation via GitHub Actions*`;
            
            // Adicionar coment√°rio ao PR
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });